name: Release

on:
  push:
    branches: ['main']
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # create GitHub release
      id-token: write      # OIDC to PyPI (trusted publishing)

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pipx install uv

      - name: Install deps
        run: uv sync --dev

      - name: Verify tag matches package version (uv)
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"     # e.g. v1.4.3
          TAG_VERSION="${TAG#v}"       # -> 1.4.3

          PKG_VERSION="$(uv version --short)"  # -> 1.4.3

          echo "Tag version: ${TAG_VERSION}"
          echo "uv version:  ${PKG_VERSION}"

          if [[ "${TAG_VERSION}" != "${PKG_VERSION}" ]]; then
            echo "::error title=Version mismatch::Tag '${TAG_VERSION}' does not match uv version '${PKG_VERSION}'."
            exit 1
          fi

      - name: Run unit tests
        run: uv run pytest -m "not golden"

      - name: Generate monofile
        run: uv run python monofile-generator/generate-monofile.py

      - name: Commit updated monofile
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add monofile.ipynb
          git diff --cached --quiet || git commit -m "Update monofile for ${GITHUB_REF_NAME}"
          git push origin HEAD:main

      - name: Build distributions
        run: uv build
        # uv build produces dist/*  :contentReference[oaicite:3]{index=3}

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        # trusted publishing requires id-token: write and no password fields :contentReference[oaicite:4]{index=4}

      - name: Create GitHub Release + upload dist/*
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true